name: Staging Deployment

on:
  push:
    branches:
      - staging
  workflow_dispatch:

jobs:
  lint:
    name: Run Ruff Linter
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Ruff
        run: pip install ruff

      - name: Run Ruff linter
        run: ruff check .

  deploy:
    name: Deploy to Staging
    needs: lint
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        server:
          - name: EC2-Server-1
            host_secret: EC2_HOST_1
            key_secret: EC2_SSH_PRIVATE_KEY_1
          # - name: EC2-Server-2
          #   host_secret: EC2_HOST_2
          #   key_secret: EC2_SSH_PRIVATE_KEY_2
          # - name: EC2-Server-3
          #   host_secret: EC2_HOST_3
          #   key_secret: EC2_SSH_PRIVATE_KEY_3
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH and Get Credentials
        id: setup
        env:
          # Shared secrets (same for all servers)
          SSH_USER: ${{ secrets.EC2_USERNAME }}
          APP_DIR: ${{ secrets.APP_DIRECTORY }}
          # Server-specific secrets
          SSH_KEY_1: ${{ secrets.EC2_SSH_PRIVATE_KEY_1 }}
          # SSH_KEY_2: ${{ secrets.EC2_SSH_PRIVATE_KEY_2 }}
          # SSH_KEY_3: ${{ secrets.EC2_SSH_PRIVATE_KEY_3 }}
          SSH_HOST_1: ${{ secrets.EC2_HOST_1 }}
          # SSH_HOST_2: ${{ secrets.EC2_HOST_2 }}
          # SSH_HOST_3: ${{ secrets.EC2_HOST_3 }}
        run: |
          mkdir -p ~/.ssh
          
          # Determine which host and key to use based on matrix server name
          if [ "${{ matrix.server.name }}" == "EC2-Server-1" ]; then
            echo "$SSH_KEY_1" > ~/.ssh/deploy_key
            SSH_HOST="$SSH_HOST_1"
          elif [ "${{ matrix.server.name }}" == "EC2-Server-2" ]; then
            echo "$SSH_KEY_2" > ~/.ssh/deploy_key
            SSH_HOST="$SSH_HOST_2"
          elif [ "${{ matrix.server.name }}" == "EC2-Server-3" ]; then
            echo "$SSH_KEY_3" > ~/.ssh/deploy_key
            SSH_HOST="$SSH_HOST_3"
          fi
          
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true
          
          echo "ssh_host=$SSH_HOST" >> $GITHUB_OUTPUT
          echo "ssh_user=$SSH_USER" >> $GITHUB_OUTPUT
          echo "app_dir=$APP_DIR" >> $GITHUB_OUTPUT

      - name: Stop Application
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            "${{ steps.setup.outputs.ssh_user }}@${{ steps.setup.outputs.ssh_host }}" \
            "powershell -Command \"\$ErrorActionPreference = 'Stop'; New-Item -ItemType File -Path '${{ steps.setup.outputs.app_dir }}\logs\STOP' -Force -ErrorAction SilentlyContinue | Out-Null; \$pythonProcess = Get-Process -Name python -ErrorAction SilentlyContinue; if (\$pythonProcess) { Write-Host 'Python process found. Stopping...'; Stop-Process -Name python -Force; Write-Host 'Python process stopped successfully.' } else { Write-Error 'ERROR: Python process is not running. Cannot stop a process that does not exist.'; exit 1 }\""

      - name: Pull Latest Code
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            "${{ steps.setup.outputs.ssh_user }}@${{ steps.setup.outputs.ssh_host }}" \
            "powershell -Command \"if (-not (Test-Path '${{ steps.setup.outputs.app_dir }}')) { Write-Error \"Application directory does not exist: ${{ steps.setup.outputs.app_dir }}\"; exit 1 }; cd '${{ steps.setup.outputs.app_dir }}'; \$oldErrorAction = \$ErrorActionPreference; \$ErrorActionPreference = 'SilentlyContinue'; \$null = git rev-parse --git-dir 2>&1; \$isGitRepo = (\$LASTEXITCODE -eq 0); \$ErrorActionPreference = \$oldErrorAction; if (-not \$isGitRepo) { Write-Error \"ERROR: Not a git repository. Directory '${{ steps.setup.outputs.app_dir }}' exists but is not a git repository. Please ensure the repository has been cloned to this location.\"; exit 1 }; \$ErrorActionPreference = 'Stop'; git pull origin staging; if (\$LASTEXITCODE -ne 0) { Write-Error \"Git pull failed with exit code \$LASTEXITCODE\"; exit \$LASTEXITCODE }\""

      - name: Restart Application on ${{ matrix.server.name }}
        run: |
          # Use the setup outputs for connection details
          USER="${{ steps.setup.outputs.ssh_user }}"
          HOST="${{ steps.setup.outputs.ssh_host }}"

          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            "${USER}@${HOST}" \
            "powershell -Command \"
            \$ErrorActionPreference = 'Stop';
            \$TaskName = 'BrowserAutomationStartup';

            Write-Host '--- Restarting scheduled task ---';

            # 1. Get current state via schtasks
            \$TaskInfo = schtasks /query /tn \$TaskName /fo LIST /v 2>\$null;
            \$CurrentState = 'Unknown';
            if (\$TaskInfo -match 'State:\\s+(\\w+)') {
                \$CurrentState = \$Matches[1];
                Write-Host \\\"[STATUS BEFORE] Task '\$TaskName' state: \$CurrentState\\\";
            } else {
                Write-Host \\\"[STATUS BEFORE] Could not determine state for task '\$TaskName'.\\\";
            }

            # 2. If running, stop first
            if (\$CurrentState -eq 'Running') {
                Write-Host \\\"Task '\$TaskName' is RUNNING. Attempting to stop it...\\\";
                schtasks /end /tn \$TaskName 2>\$null | Out-Null;
                if (\$LASTEXITCODE -ne 0) {
                    Write-Host \\\"Warning: schtasks /end returned exit code \$LASTEXITCODE (may already be stopped).\\\";
                }
                Start-Sleep -Seconds 5;
            }

            # 3. Trigger the task
            Write-Host \\\"Triggering scheduled task: '\$TaskName'...\\\";
            schtasks /run /tn \$TaskName | Out-Null;
            if (\$LASTEXITCODE -ne 0) {
                Write-Error \\\"Failed to RUN scheduled task '\$TaskName'. Exit code: \$LASTEXITCODE\\\";
                exit 1;
            }

            # 4. Poll for Running state OR python process up to ~60s
            \$Started = \$false;
            for (\$i = 0; \$i -lt 30; \$i++) {
                Start-Sleep -Seconds 2;

                # Check scheduled task state again
                \$PollInfo = schtasks /query /tn \$TaskName /fo LIST /v 2>\$null;
                if (\$PollInfo -match 'State:\\s+(\\w+)') {
                    \$PollState = \$Matches[1];
                    Write-Host \\\"[POLL] Task state at iteration \$i: \$PollState\\\";
                    if (\$PollState -eq 'Running') {
                        \$Started = \$true;
                        break;
                    }
                }

                # Fallback: check python process
                if (Get-Process -Name python -ErrorAction SilentlyContinue) {
                    Write-Host \\\"[POLL] python process detected. Assuming application has started.\\\";
                    \$Started = \$true;
                    break;
                }
            }

            if (-not \$Started) {
                Write-Error \\\"Task '\$TaskName' did not reach RUNNING state and python process not found within timeout.\\\";
                exit 1;
            }

            Write-Host '✅ Task restart sequence finished; application should be running.';
            \""
            
      - name: Verify Application Running Status
        run: |
          # Use the setup outputs for connection details
          USER="${{ steps.setup.outputs.ssh_user }}"
          HOST="${{ steps.setup.outputs.ssh_host }}"

          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            "${USER}@${HOST}" \
            "powershell -Command \"
            \$ErrorActionPreference = 'Stop';
            \$TaskName = 'BrowserAutomationStartup';

            Write-Host '--- Deployment Verification ---';

            # 1. Get high-level task info (LastRunTime, LastTaskResult)
            try {
                \$info = Get-ScheduledTaskInfo -TaskName \$TaskName -TaskPath '\\';
                Write-Host \\\"[TASK INFO] LastRunTime: \$('\$' + 'info.LastRunTime' -replace '\\\$','') -> \$info.LastRunTime\\\";
                Write-Host \\\"[TASK INFO] LastTaskResult: \$('\$' + 'info.LastTaskResult' -replace '\\\$','') -> \$info.LastTaskResult\\\";
            } catch {
                Write-Host \\\"Get-ScheduledTaskInfo not available or failed. Falling back to schtasks only.\\\";
                \$info = \$null;
            }

            # 2. Check current state with schtasks
            \$TaskInfo = schtasks /query /tn \$TaskName /fo LIST /v 2>\$null;
            \$CurrentState = 'Unknown';
            if (\$TaskInfo -match 'State:\\s+(\\w+)') {
                \$CurrentState = \$Matches[1];
                Write-Host \\\"[VERIFY STATUS] Current task state: \$CurrentState\\\";
            } else {
                Write-Host \\\"[VERIFY STATUS] Could not parse current task state from schtasks output.\\\";
            }

            # 3. Check if python process is running
            \$pythonProc = Get-Process -Name python -ErrorAction SilentlyContinue;
            if (\$pythonProc) {
                Write-Host \\\"[VERIFY PROC] python process is RUNNING (PID(s): \$((\$pythonProc | Select-Object -ExpandProperty Id) -join ', ')).\\\";
            } else {
                Write-Host \\\"[VERIFY PROC] python process is NOT running.\\\";
            }

            # 4. Decide success/failure
            \$LastResultOk = \$false;
            if (\$info -ne \$null -and \$info.LastTaskResult -eq 0) {
                \$LastResultOk = \$true;
            }

            if (\$CurrentState -eq 'Running' -or (\$LastResultOk -and \$pythonProc)) {
                Write-Host '✅ Verification succeeded: task is healthy and/or python process is running.';
                exit 0;
            }

            # If we reach here, something looks off
            Write-Error \\\"❌ Verification failed: Task state '\$CurrentState', LastTaskResult = \$([string]::Join('',(\$info?.LastTaskResult))), python running = \$([bool]\$pythonProc).\\\";
            exit 1;
            \""

      - name: Verify Deployment
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            "${{ steps.setup.outputs.ssh_user }}@${{ steps.setup.outputs.ssh_host }}" \
            "powershell -Command \"if (-not (Test-Path '${{ steps.setup.outputs.app_dir }}')) { Write-Error \"Application directory does not exist: ${{ steps.setup.outputs.app_dir }}\"; exit 1 }; cd '${{ steps.setup.outputs.app_dir }}'; \$oldErrorAction = \$ErrorActionPreference; \$ErrorActionPreference = 'SilentlyContinue'; \$null = git rev-parse --git-dir 2>&1; \$isGitRepo = (\$LASTEXITCODE -eq 0); \$ErrorActionPreference = \$oldErrorAction; if (-not \$isGitRepo) { Write-Error \"ERROR: Not a git repository. Directory '${{ steps.setup.outputs.app_dir }}' exists but is not a git repository.\"; exit 1 }; \$ErrorActionPreference = 'Stop'; git log -1 --oneline; if (\$LASTEXITCODE -ne 0) { Write-Error \"Failed to verify deployment. Git log returned exit code \$LASTEXITCODE\"; exit \$LASTEXITCODE }\""

      - name: Cleanup SSH Key
        if: always()
        run: rm -f ~/.ssh/deploy_key