name: Staging Deployment

on:
  push:
    branches:
      - staging
  workflow_dispatch:

jobs:
  lint:
    name: Run Ruff Linter
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Ruff
        run: pip install ruff

      - name: Run Ruff linter
        run: ruff check .

  deploy:
    name: Deploy to Staging - ${{ matrix.server.name }}
    needs: lint
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      BRANCH: ${{ github.ref_name || github.head_ref }}

    strategy:
      matrix:
        server:
          - name: EC2-Server-1
            host_secret: EC2_HOST_1
            key_secret: EC2_SSH_PRIVATE_KEY_1
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH and Get Credentials (Dynamic Secret Access)
        id: setup
        env:
          SSH_USER: ${{ secrets.EC2_USERNAME }}
          APP_DIR: ${{ secrets.APP_DIRECTORY }}
          SSH_KEY: ${{ secrets[matrix.server.key_secret] }}
          SSH_HOST: ${{ secrets[matrix.server.host_secret] }}
          
        run: |
          set -e
          mkdir -p ~/.ssh
          echo "${{ env.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ env.SSH_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true
          echo "ssh_host=${{ env.SSH_HOST }}" >> $GITHUB_OUTPUT
          echo "ssh_user=${{ env.SSH_USER }}" >> $GITHUB_OUTPUT
          echo "app_dir=${{ env.APP_DIR }}" >> $GITHUB_OUTPUT

      - name: Stop Application on ${{ matrix.server.name }}
        run: |
          set -e
          echo "Stopping existing application process on server ${{ matrix.server.name }} if running..."
          USER="${{ steps.setup.outputs.ssh_user }}"
          HOST="${{ steps.setup.outputs.ssh_host }}"
          APP_DIR="${{ steps.setup.outputs.app_dir }}"
          
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            "${USER}@${HOST}" \
            "powershell -Command \"\$ErrorActionPreference = 'Stop'; \$pythonProcess = Get-Process -Name python -ErrorAction SilentlyContinue; if (\$pythonProcess) { Write-Warning 'Python process found. Stopping...'; New-Item -ItemType File -Path '${{ steps.setup.outputs.app_dir }}\logs\STOP'; Stop-Process -Name python -Force; Write-Warning 'Python process stopped successfully.'} else { Write-Warning 'INFO: Python process was not running. Exiting with error.'; exit 0 }\""

      - name: Pull Latest Code on ${{ matrix.server.name }}
        id: pull
        run: |
          set -e
          sleep 30
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            "${{ steps.setup.outputs.ssh_user }}@${{ steps.setup.outputs.ssh_host }}" \
            "powershell -Command \"
              git config --global user.email 'github-actions@github.com'
              git config --global user.name 'GitHub Actions'
              if (-not (Test-Path '${{ steps.setup.outputs.app_dir }}')) { 
                Write-Error 'Application directory does not exist: ${{ steps.setup.outputs.app_dir }}'
                exit 1
              }
              cd '${{ steps.setup.outputs.app_dir }}'
              \$oldErrorAction = \$ErrorActionPreference
              \$ErrorActionPreference = 'SilentlyContinue'
              \$null = git rev-parse --git-dir 2>&1
              \$isGitRepo = (\$LASTEXITCODE -eq 0)
              \$ErrorActionPreference = \$oldErrorAction
              if (-not \$isGitRepo) { 
                Write-Error 'ERROR: Not a git repository. Directory '${{ steps.setup.outputs.app_dir }}' exists but is not a git repository.'
                exit 1
              }
              \$ErrorActionPreference = 'Stop'
              git pull origin ${{ env.BRANCH }}
              if (\$LASTEXITCODE -ne 0) { 
                Write-Error 'Git pull failed with exit code \$LASTEXITCODE'
                exit \$LASTEXITCODE
              }
            \""

      - name: Start Application on ${{ matrix.server.name }}
        id: start
        run: |
          set -e
          sleep 40
          USER="${{ steps.setup.outputs.ssh_user }}"
          HOST="${{ steps.setup.outputs.ssh_host }}"
          TASK_NAME="BrowserAutomationStartup"
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            "${USER}@${HOST}" \
            "cmd.exe /c \"schtasks /run /tn ${TASK_NAME}\""

      - name: Verify Application Process (Real-time Polling)
        run: |
          set -e
          USER="${{ steps.setup.outputs.ssh_user }}"
          HOST="${{ steps.setup.outputs.ssh_host }}"
          MAX_ATTEMPTS=5
          WAIT_SECONDS=60
          PROCESS_NAME='python'
          for i in $(seq 1 $MAX_ATTEMPTS); do
              echo "[POLL $i/$MAX_ATTEMPTS] Waiting $WAIT_SECONDS seconds... Checking for process '${PROCESS_NAME}'"
              sleep $WAIT_SECONDS
              CHECK_RESULT=$(ssh -i ~/.ssh/deploy_key \
                -o StrictHostKeyChecking=no \
                -o UserKnownHostsFile=~/.ssh/known_hosts \
                "${USER}@${HOST}" \
                "cmd.exe /c \"tasklist /nh /fi \"IMAGENAME eq ${PROCESS_NAME}.exe\" 2>&1\"" || true)
              if echo "$CHECK_RESULT" | grep -i "${PROCESS_NAME}.exe"; then
                  echo "Process '${PROCESS_NAME}' found running on the VM."
                  exit 0
              fi
          done
          echo "TIMEOUT: Application process '${PROCESS_NAME}' not found running after $(($MAX_ATTEMPTS * $WAIT_SECONDS)) seconds."
          exit 1

      - name: Verify Deployment Commit Hash on ${{ matrix.server.name }}
        run: |
          set -e
          USER="${{ steps.setup.outputs.ssh_user }}"
          HOST="${{ steps.setup.outputs.ssh_host }}"
          APP_DIR="${{ steps.setup.outputs.app_dir }}"
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            "${USER}@${HOST}" \
            "powershell -Command \"\$GitExe = 'C:\Program Files\Git\bin\git.exe'; cd '${APP_DIR}'; & \"\$GitExe\" log -1 --oneline | Out-String;\""

      - name: Rollback / Ensure application running on failure
        if: failure() && (steps.pull.conclusion == 'failure' || steps.start.conclusion == 'failure')
        run: |
          set -e
          USER="${{ steps.setup.outputs.ssh_user }}"
          HOST="${{ steps.setup.outputs.ssh_host }}"
          TASK_NAME="BrowserAutomationStartup"
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            "${USER}@${HOST}" \
            "cmd.exe /c \"schtasks /run /tn ${TASK_NAME}\"" || true

      - name: Cleanup SSH Key
        if: always()
        run: rm -f ~/.ssh/deploy_key
