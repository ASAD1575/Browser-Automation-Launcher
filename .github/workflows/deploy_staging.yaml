name: Staging Deployment

on:
  push:
    branches:
      - staging
  workflow_dispatch:

jobs:
  lint:
    name: Run Ruff Linter
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Ruff
        run: pip install ruff

      - name: Run Ruff linter
        run: ruff check .

  deploy:
    name: Deploy to Staging
    needs: lint
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        server:
          - name: EC2-Server-1
            host_secret: EC2_HOST_1
            key_secret: EC2_SSH_PRIVATE_KEY_1
          - name: EC2-Server-2
            host_secret: EC2_HOST_2
            key_secret: EC2_SSH_PRIVATE_KEY_2
          - name: EC2-Server-3
            host_secret: EC2_HOST_3
            key_secret: EC2_SSH_PRIVATE_KEY_3
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH and Get Credentials
        id: setup
        env:
          # Shared secrets (same for all servers)
          SSH_USER: ${{ secrets.EC2_USERNAME }}
          APP_DIR: ${{ secrets.APP_DIRECTORY }}
          # Server-specific secrets
          SSH_KEY_1: ${{ secrets.EC2_SSH_PRIVATE_KEY_1 }}
          SSH_KEY_2: ${{ secrets.EC2_SSH_PRIVATE_KEY_2 }}
          SSH_KEY_3: ${{ secrets.EC2_SSH_PRIVATE_KEY_3 }}
          SSH_HOST_1: ${{ secrets.EC2_HOST_1 }}
          SSH_HOST_2: ${{ secrets.EC2_HOST_2 }}
          SSH_HOST_3: ${{ secrets.EC2_HOST_3 }}
        run: |
          mkdir -p ~/.ssh
          
          # Determine which host and key to use based on matrix server name
          if [ "${{ matrix.server.name }}" == "EC2-Server-1" ]; then
            echo "$SSH_KEY_1" > ~/.ssh/deploy_key
            SSH_HOST="$SSH_HOST_1"
          elif [ "${{ matrix.server.name }}" == "EC2-Server-2" ]; then
            echo "$SSH_KEY_2" > ~/.ssh/deploy_key
            SSH_HOST="$SSH_HOST_2"
          elif [ "${{ matrix.server.name }}" == "EC2-Server-3" ]; then
            echo "$SSH_KEY_3" > ~/.ssh/deploy_key
            SSH_HOST="$SSH_HOST_3"
          fi
          
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true
          
          echo "ssh_host=$SSH_HOST" >> $GITHUB_OUTPUT
          echo "ssh_user=$SSH_USER" >> $GITHUB_OUTPUT
          echo "app_dir=$APP_DIR" >> $GITHUB_OUTPUT

      - name: Stop Application
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            "${{ steps.setup.outputs.ssh_user }}@${{ steps.setup.outputs.ssh_host }}" \
            "powershell -Command \"New-Item -ItemType File -Path '${{ steps.setup.outputs.app_dir }}\logs\STOP' -Force -ErrorAction SilentlyContinue; Stop-Process -Name python -Force -ErrorAction SilentlyContinue\""

      - name: Pull Latest Code
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            "${{ steps.setup.outputs.ssh_user }}@${{ steps.setup.outputs.ssh_host }}" \
            "powershell -Command \"cd '${{ steps.setup.outputs.app_dir }}'; git pull origin staging\""

      - name: Restart Application
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            "${{ steps.setup.outputs.ssh_user }}@${{ steps.setup.outputs.ssh_host }}" \
            "powershell -Command \"schtasks /run /tn 'BrowserAutomationStartup'\""

      - name: Verify Deployment
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            "${{ steps.setup.outputs.ssh_user }}@${{ steps.setup.outputs.ssh_host }}" \
            "powershell -Command \"cd '${{ steps.setup.outputs.app_dir }}'; git log -1 --oneline\""

      - name: Cleanup SSH Key
        if: always()
        run: rm -f ~/.ssh/deploy_key

